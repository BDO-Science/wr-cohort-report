# Sacramento-San Joaquin Delta Juveniles

This section describes environmental attributes associated with and responses during the out-migrating juvenile life stage in the Sacramento-San Joaquin Delta.

```{r setup5, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(ggplot2) 
library(dplyr) 
library(lubridate) 
library(viridis)
library(sharpshootR)
library(plotly)
library(here)
library(readr)
library(ggridges)
library(janitor)
library(curl)

library(kableExtra)
library(flextable)
source("functions.R")
source("parameters.R")
```

---

## Habitat Attributes

1.  Rearing Habitat Capacity (Floodplain Connectivity)

-   Weir overtopping

---


### Food Availability

```{r}

mesos <- read_csv("data_raw/zooper_meso.csv") %>%
  filter(!is.na(Region)) %>%
 mutate(Month_fac = factor(Month_fac,
                    levels = c("Dec", "Jan", "Feb", "Mar", "Apr","May", "Jun")),
        Region= factor(Region, levels = c("Far West", "West", "North", "South")))

macros <- read_csv("data_raw/zooper_macro.csv") %>%
  filter(!is.na(Region)) %>%
 mutate(Month_fac = factor(Month_fac,
                    levels = c("Dec", "Jan", "Feb", "Mar", "Apr","May", "Jun")),
        Region= factor(Region, levels = c("Far West", "West", "North", "South")))
```


```{r meso-fig, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = paste("Zooplankton Abundance in the Delta, December ", report_year, "-", "June ", report_year+1, " and 10-year average CPUE")}
ggplot(mesos) + 
  geom_col(aes(Month_fac, meanCPUE, fill = Year_type), position = position_dodge(), width = 0.6) + theme_bw() + 
  labs(y= "CPUE", x= "Month") + 
  scale_fill_manual(values = c("goldenrod3", "gray70"))+
  facet_grid(Region~Order, scales = "free_y") +
  theme_bw() + 
  theme(legend.position = "top")
```


```{r macro-fig, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = paste("Amphipod and Mysid Abundance in the Delta, December ", report_year, "and 10-year average CPUE. Data currently include only EMP data from December ", report_year)}

ggplot(macros) + 
  geom_col(aes(Month_fac, meanCPUE, fill = Year_type), position = position_dodge(), width = 0.6) + theme_bw() + 
  labs(y= "CPUE", x= "Month") + 
  scale_fill_manual(values = c("goldenrod3", "gray70"))+
  facet_grid(Region~Order, scales = "free_y")+
  theme_bw() + 
  theme(legend.position = "top")
```

---

## Environmental Drivers

---

### Sacramento River Flow and Delta Outflow

```{r}
flow_fpt_monthly <- readRDS(paste0("data_raw/flow_fpt_monthly_", year(start), "-", year(end2), ".rds")) %>%
  filter(month_num %in% c(12, 1, 2, 3, 4, 5, 6))
flow_OMR_monthly <- readRDS(paste0("data_raw/omr_OMR_monthly_", year(start), "-", year(end2), ".rds")) %>%
  filter(month_num %in% c(12, 1, 2, 3, 4, 5, 6))
outflow_monthly <- readRDS(paste0("data_raw/outflow_monthly_", year(start), "-", year(end2), ".rds")) %>%
  filter(month_num %in% c(12, 1, 2, 3, 4, 5, 6))

flow_delta_monthly <- rbind(flow_fpt_monthly, outflow_monthly,flow_OMR_monthly) %>%
  select(-month_num)
```


```{r deltaflow-tab}
flow_delta_monthly_t <- flow_delta_monthly
colnames(flow_delta_monthly_t) <- stringr::str_to_title(colnames(flow_delta_monthly_t))

kable(flow_delta_monthly_t,
      label = NA,
      vline = "",
      caption = paste("Sacramento River at Freeport (FPT), Delta Outflow (DTO), Old and Middle River (OMR) Mean, Maximum, Minimum Monthly Flows (cfs) in", report_year, "-", report_year+1),
      valign = "t") %>%
  kable_classic(html_font = "Cambria") %>%
      row_spec(c(7,14,21),extra_css = "border-bottom: 1px solid;")
```

```{r FPTflow-fig, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = paste("Freeport (FPT) Average Flows (cfs) in",report_year, "and over the 10-year average"), fig.width = 8, fig.height = 4.5}
flow_fpt <- readRDS(paste0("data_raw/flow_fpt_plot_data_", year(start), "-", year(end2), ".rds")) %>%
  filter(month %in% c(12, 1, 2, 3, 4, 5, 6)) %>%
  mutate(label = "Sacramento River at Freeport")

ggplotly(ggplot(flow_fpt) + 
  geom_line(aes(date, flow, color = plot_year, linetype = plot_year)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %d") +
  scale_color_manual(values = c("black", "steelblue")) +
  scale_linetype_manual(values = c("dashed", "solid")) +
  facet_wrap(~label, nrow = 2) + 
  labs(y = "Flow (cfs)") +
  theme_plots )
```

```{r DTOflow-fig, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = paste("Delta Outflow (DTO) in",report_year, "and over the 10-year average"), fig.width = 8, fig.height = 4.5}
outflow<- readRDS(paste0("data_raw/outflow_plot_data_", year(start), "-", year(end2), ".rds")) %>%
  filter(month %in% c(12, 1, 2, 3, 4, 5, 6)) %>%
  mutate(label = "Delta Outflow")

ggplotly(ggplot(outflow) + 
  geom_line(aes(date, Outflow, color = plot_year, linetype = plot_year)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %d") +
  scale_color_manual(values = c("black", "steelblue")) +
  scale_linetype_manual(values = c("dashed", "solid")) +
  facet_wrap(~label, nrow = 2) + 
  labs(y = "Flow (cfs)") +
  theme_plots )
```

```{r OMRflow-fig, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = paste("OMR Flow (OMR) (cfs) in",report_year, "and over the 10-year average"), fig.width = 8, fig.height = 4.5}
omr<- readRDS(paste0("data_raw/omr_OMR_plot_data_", year(start), "-", year(end2), ".rds")) %>%
  filter(month %in% c(12, 1, 2, 3, 4, 5, 6)) %>%
  mutate(label = "Old and Middle River")

ggplotly(ggplot(omr) + 
  geom_line(aes(date, omr, color = plot_year, linetype = plot_year)) +
   geom_hline(yintercept = 0, linetype = "dotted") + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b %d") +
  scale_color_manual(values = c("black", "steelblue")) +
  scale_linetype_manual(values = c("dashed", "solid")) +
  facet_wrap(~label) + 
  labs(y = "Flow (cfs)") +
  theme_plots )
```

```{r calculate_env_juv_delta,echo = FALSE}
monthly_fpt <- flow_delta_monthly %>% filter(station == "FPT")
max_flow_fpt <- max(monthly_fpt$max)
max_mean_flow_fpt <- max(monthly_fpt$mean)
max_flow_fpt_month <- monthly_fpt %>% filter(max == max_flow_fpt) %>% select(month)
max_mean_flow_fpt_month <- monthly_fpt %>% filter(mean == max_mean_flow_fpt) %>% select(month)

monthly_dto <- flow_delta_monthly %>% filter(station == "DTO")
max_flow_dto <- max(monthly_dto$max)
max_mean_flow_dto <- max(monthly_dto$mean)
max_flow_dto_month <- monthly_dto %>% filter(max == max_flow_dto) %>% select(month)
max_mean_flow_dto_month <- monthly_dto %>% filter(mean == max_mean_flow_dto) %>% select(month)

monthly_omr <- flow_delta_monthly %>% filter(station == "OMR") 
min_flow_omr <- min(monthly_omr$min)
min_mean_flow_omr <- min(monthly_omr$mean)
min_flow_omr_month <- monthly_omr %>% filter(min == min_flow_omr) %>% select(month)
min_mean_flow_omr_month <- monthly_omr %>% filter(mean == min_mean_flow_omr) %>% select(month)
```

**Summary**

-   **Sacramento River at Freeport:** Peak flows were **`r max_flow_fpt`** cfs and occurred in **`r max_flow_fpt_month[1]`**. The highest mean flows were **`r max_mean_flow_fpt`** cfs and occurred in **`r max_mean_flow_fpt_month`**. Flow was generally lower than average.

-   **Delta Outflow:** Peak Delta outflow was **`r max_flow_dto`** cfs and occurred in **`r max_flow_dto_month[1]`**. The highest mean Delta outflow was **`r max_mean_flow_dto`** cfs and occurred in **`r max_mean_flow_dto_month`**. Flow was generally lower than average.

-   **Old and Middle River:** The most negative OMR flows were **`r min_flow_omr`** cfs and occurred in **`r min_flow_omr_month[1]`**. The most negative mean OMR flows were **`r min_mean_flow_omr`** cfs and occurred in **`r min_mean_flow_omr_month`**. OMR was generally similar to average.

---

### Water Temperature

```{r FPTSUSSWEGSSMALwtemp-tab}
wtemp_delta_df <- readRDS(paste0("data_raw/wtemp_cdec_FPT_SUS_SWE_GSS_MAL_", year(start), "-", year(end2), ".rdsxz")) 

wtemp_delta_monthly <- f_monthly_extrayear_thresh_greater(wtemp_delta_df, WaterTemp, 63) %>%
  mutate(station = factor(station, levels = c("FPT", "SUS", "SWE", "GSS" ,"MAL"))) %>%
  filter(month_num %in% c(12, 1, 2, 3, 4, 5,6)) %>%
  select(-month_num) %>%
  arrange(station) 

wtemp_delta_monthly2 <- f_monthly_extrayear_thresh_greater(wtemp_delta_df, WaterTemp, 57.2) %>%
  mutate(station = factor(station, levels = c("FPT", "SUS", "SWE", "GSS" ,"MAL"))) %>%
  filter(month_num %in% c(12, 1, 2, 3, 4, 5,6)) %>%
  select(-month_num) %>%
  arrange(station) %>%
  rename(flag_days2 = flag_days)

wtemp_delta_monthly_t <- wtemp_delta_monthly2 %>% left_join(wtemp_delta_monthly) %>%
  rename("Days > 63 degF" = flag_days,
         "Days > 57.2 degF" = flag_days2)

colnames(wtemp_delta_monthly_t) <- stringr::str_to_title(colnames(wtemp_delta_monthly_t))

kable(wtemp_delta_monthly_t,
      label = NA,
      vline = "",
      caption = paste("FPT (Sacramento River at Freeport), SUS (Steamboat Slough below Sutter Slough), SWE (Sacramento River at Walnut Grove), GSS (Georgiana Slough at Sacramento River), MAL (Sacramento River at Mallard Island) Mean, Maximum, Minimum Monthly Water Temperature (°F) in", report_year, "-", report_year+1),
      valign = "t") %>%
  kable_classic(html_font = "Cambria") %>%
      row_spec(c(7,14,21,28),extra_css = "border-bottom: 1px solid;")
```

```{r calculate_temps_juv_delta, echo = FALSE}
monthly_wtemp_fpt_delta <- wtemp_delta_monthly %>% filter(station == "FPT")
max_wtemp_fpt_delta <- max(monthly_wtemp_fpt_delta$max)
max_mean_wtemp_fpt_delta <- max(monthly_wtemp_fpt_delta$mean)
max_wtemp_fpt_delta_month <- monthly_wtemp_fpt_delta %>% filter(max == max_wtemp_fpt_delta) %>% select(month)
max_mean_wtemp_fpt_delta_month <- monthly_wtemp_fpt_delta %>% filter(mean == max_mean_wtemp_fpt_delta) %>% select(month)

monthly_wtemp_sus_delta <- wtemp_delta_monthly %>% filter(station == "SUS")
max_wtemp_sus_delta <- max(monthly_wtemp_sus_delta$max)
max_mean_wtemp_sus_delta <- max(monthly_wtemp_sus_delta$mean)
max_wtemp_sus_delta_month <- monthly_wtemp_sus_delta %>% filter(max == max_wtemp_sus_delta) %>% select(month)
max_mean_wtemp_sus_delta_month <- monthly_wtemp_sus_delta %>% filter(mean == max_mean_wtemp_sus_delta) %>% select(month)

monthly_wtemp_gss_delta <- wtemp_delta_monthly %>% filter(station == "GSS")
max_wtemp_gss_delta <- max(monthly_wtemp_gss_delta$max)
max_mean_wtemp_gss_delta <- max(monthly_wtemp_gss_delta$mean)
max_wtemp_gss_delta_month <- monthly_wtemp_gss_delta %>% filter(max == max_wtemp_gss_delta) %>% select(month)
max_mean_wtemp_gss_delta_month <- monthly_wtemp_gss_delta %>% filter(mean == max_mean_wtemp_gss_delta) %>% select(month)

monthly_wtemp_mal_delta <- wtemp_delta_monthly %>% filter(station == "MAL")
max_wtemp_mal_delta <- max(monthly_wtemp_mal_delta$max)
max_mean_wtemp_mal_delta <- max(monthly_wtemp_mal_delta$mean)
max_wtemp_mal_delta_month <- monthly_wtemp_mal_delta %>% filter(max == max_wtemp_mal_delta) %>% select(month)
max_mean_wtemp_mal_delta_month <- monthly_wtemp_mal_delta %>% filter(mean == max_mean_wtemp_mal_delta) %>% select(month)

t_exceed1 <- wtemp_delta_monthly_t %>%
  clean_names() %>% filter(days_57_2_degf >= 14) %>%
  group_by(station) %>% slice(1) %>% ungroup()

t_exceed2 <- wtemp_delta_monthly_t %>%
  clean_names() %>% filter(days_63_degf >= 1) %>%
  group_by(station) %>% slice(1) %>% ungroup()
```

**Summary**

-   Maximum water temperature was **`r max_wtemp_fpt_delta`** °F and occurred in **`r max_wtemp_fpt_delta_month`**. The highest mean water temperature was **`r max_mean_wtemp_fpt_delta`** °F and occurred in **`r max_mean_wtemp_fpt_delta_month`**.
-   Maximum water temperature was **`r max_wtemp_sus_delta`** °F and occurred in **`r max_wtemp_sus_delta_month`**. The highest mean water temperature was **`r max_mean_wtemp_sus_delta`** °F and occurred in **`r max_mean_wtemp_sus_delta_month`**.
-   Maximum water temperature was **`r max_wtemp_gss_delta`** °F and occurred in **`r max_wtemp_gss_delta_month`**. The highest mean water temperature was **`r max_mean_wtemp_gss_delta`** °F and occurred in **`r max_mean_wtemp_gss_delta_month`**.
-   Maximum water temperature was **`r max_wtemp_mal_delta`** °F and occurred in **`r max_wtemp_mal_delta_month`**. The highest mean water temperature was **`r max_mean_wtemp_mal_delta`** °F and occurred in **`r max_mean_wtemp_mal_delta_month`**.

- **Temperature Exceedances:**
  - **57.2°F:** Upper range of optimal rearing temperature for juvenile Chinook Salmon (Windell et al. 2017)
  - **63°F:** Temperature at which smolt development is inhibited (Windell et al. 2017)
  - Water temperature exceeded optimal rearing temperature consistently (14 days or more) starting in `r t_exceed1$month[1]` for **`r t_exceed1$station[1]`**, 
`r t_exceed1$month[2]` for **`r t_exceed1$station[2]`**, `r t_exceed1$month[3]` for **`r t_exceed1$station[3]`**, `r t_exceed1$month[4]` for **`r t_exceed1$station[4]`**, and `r t_exceed1$month[5]` for **`r t_exceed1$station[5]`**
  - Water temperature reached temperature at which smolt development is inhibited consistently starting in `r `r t_exceed2$month[1]` for **`r t_exceed2$station[1]`**, 
`r t_exceed2$month[2]` for **`r t_exceed2$station[2]`**, `r t_exceed2$month[3]` for **`r t_exceed2$station[3]`**, `r t_exceed2$month[4]` for **`r t_exceed2$station[4]`**, and `r t_exceed2$month[5]` for **`r t_exceed2$station[5]`**

---

### Dissolved Oxygen

```{r}
do_delta_df <- readRDS(paste0("data_raw/do_cdec_SRH_SXS_BLP_MAL_", year(start), "-", year(end2), ".rdsxz")) 

do_delta_monthly <- f_monthly_extrayear_thresh(do_delta_df, DO, 6) %>%
  mutate(station = factor(station, levels = c("SRH", "SXS", "BLP", "MAL"))) %>%
  filter(month_num %in% c(12, 1, 2, 3, 4, 5,6)) %>%
  select(-month_num) %>%
  arrange(station) 
```


```{r SRHSXSBLPMALDO-tab}
do_delta_monthly_t <- do_delta_monthly %>%
  rename("Days < 6 mg/L" = flag_days)

colnames(do_delta_monthly_t) <- stringr::str_to_title(colnames(do_delta_monthly_t))

kable(do_delta_monthly_t,
      label = NA,
      vline = "",
      caption = paste("SRH (Sacramento River at Hood), SXS (Steamboat Slough near Sacramento River), BLP (Blind Point), MAL (Sacramento River at Mallard Island) Mean, Maximum, Minimum Monthly DO (mg/L) in", report_year, "-", report_year+1),
      valign = "t") %>%
  kable_classic(html_font = "Cambria") %>%
      row_spec(c(7,14,21,28),extra_css = "border-bottom: 1px solid;")
```

```{r calculate_do_juv_delta, echo = FALSE}
monthly_do_srh_delta <- do_delta_monthly %>% filter(station == "SRH")
min_do_srh_delta <- min(monthly_do_srh_delta$min)
min_mean_do_srh_delta <- min(monthly_do_srh_delta$mean)
min_do_srh_delta_month <- monthly_do_srh_delta %>% filter(min == min_do_srh_delta) %>% select(month)
min_mean_do_srh_delta_month <- monthly_do_srh_delta %>% filter(mean == min_mean_do_srh_delta) %>% select(month)
srh_below_do <- if_else(min_do_srh_delta<6, "did", "did not")

monthly_do_sxs_delta <- do_delta_monthly %>% filter(station == "SXS")
min_do_sxs_delta <- min(monthly_do_sxs_delta$min)
min_mean_do_sxs_delta <- min(monthly_do_sxs_delta$mean)
min_do_sxs_delta_month <- monthly_do_sxs_delta %>% filter(min == min_do_sxs_delta) %>% select(month)
min_mean_do_sxs_delta_month <- monthly_do_sxs_delta %>% filter(mean == min_mean_do_sxs_delta) %>% select(month)
sxs_below_do <- if_else(min_do_srh_delta<6, "did", "did not")

monthly_do_blp_delta <- do_delta_monthly %>% filter(station == "BLP")
min_do_blp_delta <- min(monthly_do_blp_delta$min)
min_mean_do_blp_delta <- min(monthly_do_blp_delta$mean)
min_do_blp_delta_month <- monthly_do_blp_delta %>% filter(min == min_do_blp_delta) %>% select(month)
min_mean_do_blp_delta_month <- monthly_do_blp_delta %>% filter(mean == min_mean_do_blp_delta) %>% select(month)
blp_below_do <- if_else(min_do_srh_delta<6, "did", "did not")

monthly_do_mal_delta <- do_delta_monthly %>% filter(station == "MAL")
min_do_mal_delta <- min(monthly_do_mal_delta$min)
min_mean_do_mal_delta <- min(monthly_do_mal_delta$mean)
min_do_mal_delta_month <- monthly_do_mal_delta %>% filter(min == min_do_mal_delta) %>% select(month)
min_mean_do_mal_delta_month <- monthly_do_mal_delta %>% filter(mean == min_mean_do_mal_delta) %>% select(month)
mal_below_do <- if_else(min_do_srh_delta<6, "did", "did not")
```

**Summary**

-   Minimum dissolved oxygen was **`r min_do_srh_delta`** mg/L and occurred in **`r min_do_srh_delta_month`**. The lowest mean dissolved oxygen was **`r min_mean_do_srh_delta`** mg/L and occurred in **`r min_mean_do_srh_delta_month`**. DO **`r srh_below_do`** reach values below 6mg/L.
-   Minimum dissolved oxygen was **`r min_do_sxs_delta`** mg/L and occurred in **`r min_do_sxs_delta_month[1,]`** and **`r min_do_sxs_delta_month[2,]`**. The lowest mean dissolved oxygen was **`r min_mean_do_sxs_delta`** mg/L and occurred in **`r min_mean_do_sxs_delta_month`**. DO **`r sxs_below_do`** reach values below 6mg/L.
-   Minimum dissolved oxygen was **`r min_do_blp_delta`** mg/L and occurred in **`r min_do_blp_delta_month`**. The lowest mean dissolved oxygen was **`r min_mean_do_blp_delta`** mg/L and occurred in **`r min_mean_do_blp_delta_month`**. DO **`r blp_below_do`** reach values below 6mg/L.
-   Minimum dissolved oxygen was **`r min_do_mal_delta`** mg/L and occurred in **`r min_do_mal_delta_month`**. The lowest mean dissolved oxygen was **`r min_mean_do_mal_delta`** mg/L and occurred in **`r min_mean_do_mal_delta_month`**. DO **`r mal_below_do`** reach values below 6mg/L.

---

## Biological Response

---

### Survival

#### Hatchery Releases

```{r }
hatchery_release <- read_csv("data_raw/hatchery_release_data.csv") %>%
  mutate(rel_date = factor(rel_date)) %>%
  filter(!is.na(reach_start))

hatchery_table_delta <- hatchery_release %>%
  filter(rkm_start <=222,!is.na(reach_start)) %>%
  mutate(ReachSurvival = paste0(reach_survival_est, " (", LCL_reach, ", ", UCL_reach, ")"),
         CumulativeSurvival = paste0(cumulative_survival_est, " (", LCL_cum, ", ", UCL_cum, ")"),
         rkm_start = round(rkm_start)) %>%
  select(rel_date, reach_start, reach_end, rkm_start, ReachSurvival, CumulativeSurvival, count)

```

Hatchery WRCS are released each year from Caldwell Park. Releases for BY `r report_year` occurred in `r month(min(ymd(hatchery_table_delta$rel_date)), label = TRUE, abbr = FALSE)` and `r month(max(ymd(hatchery_table_delta$rel_date)), label = TRUE, abbr = FALSE)`. 
- Cumulative survival from release to Benicia Bridge (\@ref(tab:hatcherydelta-tab))
  - Release 1: Reach survival estimates ranged from `r hatchery_release %>% filter(rel_date == "2022-02-10") %>% summarize(min(reach_survival_est))` to `r hatchery_release %>% filter(rel_date == "2022-02-10") %>% summarize(max(reach_survival_est))`
  - Release 2: Reach survival estimates ranged from `r hatchery_release %>% filter(rel_date == "2022-03-02") %>% summarize(min(reach_survival_est))` to `r hatchery_release %>% filter(rel_date == "2022-02-10") %>% summarize(max(reach_survival_est))`


```{r hatcherydelta-tab}
kable(hatchery_table_delta,
      label = NA,
      vline = "",
      caption = "Table of Hatchery WR Juvenile Survival",
      valign = "t") %>%
  kable_classic(html_font = "Cambria") 
```


```{r hatcherysurvival-fig, echo = FALSE, message = FALSE, warning = FALSE, fig.cap ="Cumulative Survival by River Kilometer"}

plotly::ggplotly(ggplot(hatchery_release) +
  geom_point(aes(x = rkm_start, y =cumulative_survival_est, color = rel_date,
                 text = paste("Reach End:", reach_end))) +
  geom_errorbar(aes(x = rkm_start,ymin = LCL_cum, ymax = UCL_cum,  color = rel_date))  +
  geom_line(aes(x = rkm_start, y = cumulative_survival_est, color = rel_date))+
  # facet_wrap(~rel_date, nrow = 2) + 
  scale_x_continuous(trans = "reverse", breaks = seq(0, 560, by = 50)) +
  scale_color_manual(values = c("steelblue4", "chartreuse3"))+
  labs(y = "Cumulative Survival", x = "River Kilometer", color = "Release Date") +
  theme_bw())

```

---

#### Modeled Survival and Routing (STARS)

```{r survival-routing-data, echo = FALSE}
year_specific_data <- read_csv("data_raw/STARS_data.csv")
```

- Survival summary
- Routing summary


```{r survival-fig}
# Define colors for each route
colors <- c("Overall" = "black", "Yolo" = "lightblue", "Sutter" = "blue", "Steamboat" = "purple", "Sacramento" = "darkgrey", "Interior Delta" = "orange")

(survival_plot <- year_specific_data %>%
  dplyr::filter(metric == "Survival",
                !(lubridate::month(date) %in% c(6,7,8))) %>%
  group_by(route) %>%
  ggplot(aes(x = date)) +
  geom_ribbon( aes(ymin = lowerCI, ymax = upperCI,  fill = route), alpha = .1) +
  geom_line(aes(y = median, color = route), size = 1) +
  labs(x = 'Month',
       y = 'Apparent survival probability',
       subtitle = "Delta STARS Model -\nPredicted Natural Winter-run Chinook Daily Cohorts Passage, Knights Landing to Chipps Island",
       title = paste0("WY", report_year, " Survival: Median survival of daily cohorts by route"),
       caption = paste0("Data source: Delta STARS developed by USGS Quantitative Fisheries Ecology Section and deployed by SacPAS."),
       color = "Route survival,\nmedian with 80% CI",
       fill = "Route survival,\nmedian with 80% CI") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  theme(
    text = element_text(size = 15),
    panel.grid.major = element_line(linetype = "dotted"),
    panel.border = element_rect(colour = "black", fill = NA, size = .5),
    axis.ticks = element_line(size = 0.5),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()
  ))

```

```{r routing-fig}
(route_probability_plot <- year_specific_data %>%
  dplyr::filter(metric == "Routing Probability",
                !(lubridate::month(date) %in% c(6,7,8))) %>%
  group_by(route) %>%
  ggplot(aes(x = date)) +
  geom_ribbon( aes(ymin = lowerCI, ymax = upperCI,  fill = route), alpha = .1) +
  geom_line(aes(y = median, color = route), size = 0.9) +
  labs(x = 'Month',
       y = 'Routing Probability',
       subtitle = "Delta STARS Model -\nPredicted Natural Winter-run Chinook Daily Cohorts Passage, Knights Landing to Chipps Island",
       title = paste0("WY",report_year, " Route-specific probability: Proportion of daily cohorts using a specific route"),
       caption = paste0("Data source: Delta STARS developed by USGS Quantitative Fisheries Ecology Section and deployed by SacPAS.\n"),
       color = "Route probability,\nmedian with 80% CI",
       fill = "Route probability,\nmedian with 80% CI") +
  scale_y_continuous( expand = c(0,0)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  theme_minimal() +
  theme(
    text = element_text(size = 15),
    panel.grid.major = element_line(linetype = "dotted"),
    panel.border = element_rect(colour = "black", fill = NA, size = .5),
    axis.ticks = element_line(size = 0.5),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()

  ))
```

---

### Abundance

Catch for all surveys

```{r catch_surveys, echo = FALSE}
index <- read_csv("data_raw/cohort_juv_index_data_cumulative_currentyear_long.csv")
abund_delta_surveys <-  index %>%
  group_by(Survey) %>%
  summarize(Abund = max(Catch))

juvdates <- read_csv("data_raw/cohort_juv_data_cumulative_currentyear.csv")
delta_entry_first <- format(juvdates$date[match(FALSE, cummax(juvdates$`Sac Trawls`) == 0)], "%B %d, %Y")
delta_entry_median <- format(juvdates$date[match(TRUE, juvdates$`Sac Trawls`== median(juvdates$`Sac Trawls`))], "%B %d, %Y")
delta_entry_last <- format(juvdates$date[match(TRUE, juvdates$`Sac Trawls`== max(juvdates$`Sac Trawls`))], "%B %d, %Y")
delta_exit_first <- format(juvdates$date[match(FALSE, cummax(juvdates$`Chipps Island Trawls`) == 0)], "%B %d, %Y")
delta_exit_median <- format(juvdates$date[match(TRUE, juvdates$`Chipps Island Trawls`== median(juvdates$`Chipps Island Trawls`))], "%B %d, %Y")
delta_exit_last <- format(juvdates$date[match(TRUE, juvdates$`Chipps Island Trawls`== max(juvdates$`Chipps Island Trawls`))], "%B %d, %Y")
```

**Summary**

-   Juvenile WRCS cumulative total catch: 
    - Sacramento Trawls at Sherwood Harbor: **`r abund_delta_surveys$Abund[abund_delta_surveys$Survey == "Sac Trawls"]`** (Index = **`r abund_delta_surveys$Abund[abund_delta_surveys$Survey == "Sac Trawls Index"]`**)
    - Sacramento Beach Seines: **`r abund_delta_surveys$Abund[abund_delta_surveys$Survey == "Sac Beach Seines"]`** (Index = **`r abund_delta_surveys$Abund[abund_delta_surveys$Survey == "Sac Beach Seines Index"]`**)
    - Chipps Island Trawl: **`r abund_delta_surveys$Abund[abund_delta_surveys$Survey == "Chipps Island Trawls"]`**
-   Migration Timing: 
    - Delta Entry (Sacramento Trawls at Sherwood Harbor): 
      - First: **`r delta_entry_first`**    
      - Median: **`r delta_entry_median`**
      - Last: **`r delta_entry_last`**
    - Delta Exit (Chipps Island Trawl): 
      - First: **`r delta_exit_first`**    
      - Median: **`r delta_exit_median`**
      - Last: **`r delta_exit_last`**

---

### Migration Timing

Sac Trawl Data (Raw Catch by Day or Week?)

SacPAS Migration Timing Table - LAD Median Dates, 10 Year Comparison Sacramento Beach Seines, Trawls, Chipps Island Trawls


```{r}
chipps_link <- paste0("https://www.cbr.washington.edu/sacramento/data/php/rpt/hrt.php?species=CHN%3AWinter&loc=SB018&years=10&typeData=index&histYear=",report_year+1,"&outputFormat=hrtplotOnly")

seine_link <- paste0("https://www.cbr.washington.edu/sacramento/data/php/rpt/hrt.php?loc=beach&species=CHN%3AWinter&years=15&typeData=raw&histYear=", report_year+1, "&outputFormat=hrtplotOnly")

download.file(url = chipps_link,
              destfile = paste0(figures_folder, "migtiming",report_year,"_chipps.png"),
              mode="wb")

download.file(url = seine_link,
              destfile = paste0(figures_folder, "migtiming",report_year,"_seine.png"),
              mode="wb")
```

```{r beachseine-timing-fig,fig.cap = "Combined Beach Seines Migration Timing", out.width = "150%"}
knitr::include_graphics(here(paste0(figures_folder,"migtiming",report_year,
                                    "_chipps.png")))
```


```{r chipps-timing-fig,fig.cap = "Delta Exit (Chipps Island) Migration Timing", out.width = "150%"}
knitr::include_graphics(here(paste0(figures_folder,"migtiming",report_year,
                                    "_seine.png")))
```



---

### Condition

Plot of current year sizes for Salvage, Chipps, Sacramento Beach Seines, Sac Trawls at Sherwood

```{r}

```

```{r salvage_fl-fig, fig.cap = "Fork Lengths of Genetic and LAD Winter Run Chinook Salmon Juveniles at Salvage. Points indicate median fork length."}
salvage_wr <- read_csv("data_raw/salvage_allyears.csv") %>%
  mutate(WY = if_else(Month > 9, Year + 1, Year)) %>%
  filter(Length <750, 
         Adipose.Clip == "Unclipped") %>%
  mutate(Race = LAD.Race, 
         RaceType = "LAD") 

salvage_dna_wr <- salvage_wr %>%
  filter(DNA.Race == "Winter") %>%
  mutate(Race = DNA.Race, 
         RaceType = "DNA")

salvage_wr_all <- bind_rows(salvage_wr, salvage_dna_wr) %>% filter(!is.na(RaceType)) %>%
  filter(WY <= report_year)

median_salvage_fl <- salvage_wr_all %>% group_by(WY, RaceType) %>%
  summarize(Length = median(Length))

ggplot() +
  geom_density_ridges(data = salvage_wr_all, aes(x = Length, y = factor(WY), fill = RaceType), scale = 1.5, draw_baseline = FALSE) +
  geom_point(data = median_salvage_fl, aes(x = Length, y = factor(WY)), shape = 21)+
  labs(x = 'Fork Length (mm)', y = 'Water Year') +
  facet_wrap(~RaceType) + 
  theme_bw() +
  theme(legend.position = 'none',
        plot.margin = ggplot2::margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_text(margin=ggplot2::margin(t=10)),
        axis.title.y = element_text(margin=ggplot2::margin(r=10)))
```

```{r chipps_fl-fig, fig.cap = "Fork Lengths of Genetic and LAD Winter Run Chinook Salmon Juveniles at Chipps Trawl. Points indicate median fork length."}
chipps_gen <- read_csv("data_raw/chipps_genetic_data.csv")
chipps_lad <- chipps_gen %>%
  filter(LengthByDate == "Winter") %>%
  mutate(Race = LengthByDate, 
         RaceType = "LAD") 

chipps_genetic <- chipps_gen %>%
  filter(GeneticID == "Winter") %>%
  mutate(Race = GeneticID, 
         RaceType = "DNA") 

chipps_winter <- bind_rows(chipps_lad, chipps_genetic) %>%
  mutate(WY = if_else(month(SampleDate) > 9, year(SampleDate) + 1, year(SampleDate))) 

median_chipps_fl <- chipps_winter %>% group_by(WY, RaceType) %>%
  summarize(ForkLength = median(ForkLength))

ggplot() +
  geom_density_ridges(data = chipps_winter, aes(x = ForkLength, y = factor(WY), fill = RaceType), scale = 1.5, draw_baseline = FALSE) +
  geom_point(data = median_chipps_fl, aes(x = ForkLength, y = factor(WY)), shape = 21)+
  labs(x = 'Fork Length (mm)', y = 'Water Year') +
  facet_wrap(~RaceType) + 
  theme_bw() +
  theme(legend.position = 'none',
        plot.margin = ggplot2::margin(0.5,0.5,0.25,0.25, unit = 'cm'),
        axis.title.x = element_text(margin=ggplot2::margin(t=10)),
        axis.title.y = element_text(margin=ggplot2::margin(r=10)))
```

---

### Entrainment and Loss

- Describe take levels based off JPE letter
- Describe trigger levels
- Describe loss 

```{r}
jpe_genetic_lad_data <- read_csv(here("data_output/lad_genetic_loss_percent_jpe.csv"))
lad_avg_loss <- jpe_genetic_lad_data %>%
  filter(WY <= report_year + 1 & WY > report_year -9) %>%
  filter(method == "LAD")

genetic_avg_loss <- jpe_genetic_lad_data %>%
  filter(WY <= report_year + 1 & WY > report_year -9) %>%
  filter(method == "Genetic")

lad_mean10_loss <- mean(lad_avg_loss %>% filter(value_type == "total_loss") %>% pull(value))
lad_report_loss <- lad_avg_loss %>% filter(value_type == "total_loss", WY == report_year+1) %>% pull(value)
lad_loss_dir <- if_else(lad_report_loss < lad_mean10_loss, "lower than", if_else(lad_report_loss == lad_mean10_loss, "the same as", "higher than"))

gen_mean10_loss <- mean(genetic_avg_loss %>% filter(value_type == "total_loss") %>% pull(value))
gen_report_loss <- genetic_avg_loss %>% filter(value_type == "total_loss", WY == report_year+1) %>% pull(value) %>% { if(length(.) == 0) 0 else . }
gen_loss_dir <- if_else(gen_report_loss < gen_mean10_loss, "lower than", if_else(gen_report_loss == gen_mean10_loss, "the same as", "higher than"))
```

```{r}
salvage_timing <- read_csv("data_raw/salvage_timing.csv")
salvage_by_lad <- salvage_timing %>% 
  filter(water_year == report_year+1) %>%
  mutate_at(vars(first_passage_date:last_passage_date), as_date, format = "%m/%d/%Y") %>%
  filter(Survey == "Salvage")
salvage_median_lad <- salvage_timing %>%
  filter(stringr::str_detect(water_year, "Median"))%>%
  mutate_at(vars(first_passage_date:last_passage_date), as_date, format = "%m/%d") %>%
  filter(Survey == "Salvage")

salvage_by_dna <- salvage_timing %>% 
  filter(water_year == report_year+1) %>%
  mutate_at(vars(first_passage_date:last_passage_date), as_date, format = "%m/%d/%Y")%>%
  filter(Survey == "Salvage DNA")
salvage_median_dna <- salvage_timing %>%
  filter(stringr::str_detect(water_year, "Median"))%>%
  mutate_at(vars(first_passage_date:last_passage_date), as_date, format = "%m/%d")%>%
  filter(Survey == "Salvage DNA")
```


    
**Summary**

- Total LAD loss for BY `r report_year` was `r jpe_genetic_lad_data %>% filter(WY == report_year + 1,method == "LAD", value_type == "total_loss") %>% pull(value)`, which was  `r jpe_genetic_lad_data %>% filter(WY == report_year + 1, method == "LAD", value_type == "pct_total_loss") %>% pull(value) %>% format()`% of the JPE. Loss was `r lad_loss_dir` the 10-year average of `r round(lad_mean10_loss,2)` (Figure \@ref(fig:hist-loss-fig)).

- Total Genetic loss for BY `r report_year` was `r jpe_genetic_lad_data %>%filter(WY == report_year + 1, method == "Genetic", value_type == "total_loss") %>%pull(value) %>%{ if(length(.) == 0) 0 else . }`, which was `r jpe_genetic_lad_data %>%filter(WY == report_year + 1, method == "Genetic", value_type == "pct_total_loss") %>%pull(value) %>%{ if(length(.) == 0) 0 else . }`% of the JPE. Loss was `r gen_loss_dir` the 10-year average of `r round(gen_mean10_loss,2)` (Figure \@ref(fig:hist-pct-of-jpe-loss-fig)).

- Median salvage timing occurred (Figure \@ref(fig:salvage-timing-fig))


```{r}
daily_salvage <- read_csv("data_raw/delta_loss.csv")

ggplotly(ggplot(daily_salvage) + 
  geom_line(aes(Date, cumLoss, color = Facility), linewidth = 1.1) +
  # geom_point(aes(Date, Expanded.Salvage, color = Facility), size = 0.9) + 
  scale_color_manual(values = c("blue", "goldenrod3"))+
    scale_x_date(date_breaks = "1 month") + 
  labs(y = "Cumulative Loss") + 
  theme_bw())
```


```{r hist-loss-fig, fig.cap = paste0("Genetic vs Length-At-Date (LAD) Winter Run Chinook Salmon Loss through ", report_year, ". Genetic loss data provided by USBR before WY 2020.\nLAD and genetic loss after 2020 sourced from CDFW Salvage Database.")}

plot_loss <- jpe_genetic_lad_data %>%
  filter(value_type == "total_loss") %>%
  ggplot(aes(x = as.factor(WY), y = value, fill = method)) +
  geom_bar(stat = "identity", position = position_dodge(.7, preserve = "single")) +
  labs(
    x = "Water Year",
    y = "Total loss",
    fill = NULL
  ) +
  scale_y_continuous(expand = c(0, 100), labels = scales::comma_format()) +
  scale_fill_manual(
    values = c("#00BFFF", "#0072B2"),
    # breaks = c("count_gen", "count_lad"),
    labels = c("Genetic", "LAD")
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1), 
        text = element_text(size = 15),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.border = element_rect(colour = "black", fill = NA, size = 1),
        axis.ticks = element_line(size = 0.5),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank()
     )
ggplotly(plot_loss)
```

#### Loss as a Percent of JPE

```{r hist-pct-of-jpe-loss-fig, fig.cap = paste0("Genetic vs Length-At-Date (LAD) Winter Run Chinook Salmon Percent Loss of JPE through ", report_year, ". Genetic loss data provided by USBR before WY 2020.\nLAD and genetic loss after 2020 sourced from CDFW Salvage Database.")}
plot_pct_loss <- jpe_genetic_lad_data %>%
  filter(value_type == "pct_total_loss") %>%
  ggplot(aes(x = as.factor(WY), y = value, fill = method)) +
  geom_bar(stat = "identity", position = position_dodge(.7, preserve = "single")) +
  labs(
    x = "Water Year",
    y = "Percent Loss",
    fill = NULL
  ) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .06), expand = c(0, 0)) +
  scale_fill_manual(
    values = c("#00BFFF", "#0072B2"),
    # breaks = c("pct_gen", "pct_lad"),
    labels = c("Genetic", "LAD")
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1), 
        text = element_text(size = 15),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.border = element_rect(colour = "black", fill = NA, size = 1),
        axis.ticks = element_line(size = 0.5),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank()
       )
ggplotly(plot_pct_loss)
```

```{r}
salvage_link <- paste0("https://www.cbr.washington.edu/sacramento/data/php/rpt/hrt_salvage.php?species=LAD%3A1%3AWinter%3Af&years=10&histYear=", report_year+1, "&outputFormat=hrtplotOnly")

download.file(url = salvage_link,
              destfile = paste0(figures_folder, "migtiming",report_year,"_salvage.png"),
              mode="wb")


curl_download(salvage_link, destfile = paste0(figures_folder, "migtiming",report_year,"_salvage.png"), mode = "wb")

salvage_gen_link <- paste0("https://www.cbr.washington.edu/sacramento/data/php/rpt/hrt_salvage.php?species=DNA%3A1%3AWinter%3Af&years=10&outputFormat=csv&histYear=", report_year+1, "&outputFormat=hrtplotOnly")

curl_download(url = salvage_gen_link,
              destfile = paste0(figures_folder, "migtiming",report_year,"_salvage_gen.png"),
              mode="wb")
```


#### Salvage Timing

*FOR LAD WRCS:* 

- **First:** 
    - BY`r report_year`: `r format(salvage_by_lad$first_passage_date, "%B %d, %Y")`
    - 10-year median: `r format(salvage_median_lad$first_passage_date, "%B %d")`
- **Middle 50% (25% to 75%):**
    - BY`r report_year`: `r format(salvage_by_lad$x25_percent_passage_date, "%B %d, %Y")` to `r format(salvage_by_lad$x75_percent_passage_date, "%B %d, %Y")`
    - 10-year median: `r format(salvage_median_lad$x25_percent_passage_date, "%B %d")` to `r format(salvage_median_lad$x75_percent_passage_date, "%B %d")`
- **Last:**
    - BY`r report_year`: `r format(salvage_by_lad$last_passage_date, "%B %d, %Y")`
    - 10-year median: `r format(salvage_median_lad$last_passage_date, "%B %d")`

*For genetic WRCS:*

- **First:** 
    - BY`r report_year`: `r format(salvage_by_dna$first_passage_date, "%B %d, %Y")`
    - 10-year median: `r format(salvage_median_dna$first_passage_date, "%B %d")`
- **Middle 50% (25% to 75%):**
    - BY`r report_year`: `r format(salvage_by_dna$x25_percent_passage_date, "%B %d, %Y")` to `r format(salvage_by_dna$x75_percent_passage_date, "%B %d, %Y")`
    - 10-year median: `r format(salvage_median_dna$x25_percent_passage_date, "%B %d")` to `r format(salvage_median_dna$x75_percent_passage_date, "%B %d")`
- **Last:**
    - BY`r report_year`: `r format(salvage_by_dna$last_passage_date, "%B %d, %Y")`
    - 10-year median: `r format(salvage_median_dna$last_passage_date, "%B %d")`
    
```{r salvage-timing-fig,fig.cap = "Salvage Timing for LAD WRCS.", out.width = "150%"}
knitr::include_graphics(here(paste0(figures_folder,"migtiming",report_year,
                                    "_salvage.png")))
```

```{r salvage-genetic-timing-fig,fig.cap = "Salvage Timing for Genetic WRCS, starting WY2020.", out.width = "150%"}
knitr::include_graphics(here(paste0(figures_folder,"migtiming",report_year,
                                    "_salvage_gen.png")))
```




Monitoring Sources for abundance, growth/size, 
-   Sac Trawl
-   Tisdale Weir
-   Knights Landing
-   GCID
-   DJFMP
-   Yolo Bypass
-   Chipps Island Trawl (Exit)
-   Genetic (Chipps, SWP/CVP, Knights Landing, Yolo Bypass)

-   Hatchery real-time: Calfish Track/ERDDAP
-   Natural Origin Smolt survival (O Farell et al. 2018)
-   Hatchery Origin Smolt survival
-   Modeled: \*\* Juvenile: STARS \*\* Fish Model
-   Survival to Delta: Production (Hatchery JPE, Modeled JPE)
